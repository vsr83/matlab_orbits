
% JPL Horizons
%
%**********************************************************************************************
% Date__(UT)__HR:MN     R.A.__(a-apparent)__DEC  Azi____(a-app)___Elev  L_Ap_Sid_Time  Ang-diam
%**********************************************************************************************
%$$SOE
% 2022-Apr-25 00:00 A   21 55 16.92 -19 12 19.6   98.911099 -17.115599  15 50 57.6634  1892.847
% 2022-Apr-25 01:00 N   21 57 28.46 -19 02 59.9  110.974777 -10.035347  16 51 07.5198  1896.009
% 2022-Apr-25 02:00 C   21 59 32.03 -18 53 24.2  123.132741  -3.475416  17 51 17.3762  1898.967
% 2022-Apr-25 03:00 *m  22 01 28.33 -18 43 24.2  135.664824   2.259312  18 51 27.2326  1901.488
% 2022-Apr-25 04:00 *m  22 03 18.49 -18 32 53.0  148.735392   6.862202  19 51 37.0890  1903.365
% 2022-Apr-25 05:00 *m  22 05 04.05 -18 21 45.3  162.363134  10.044539  20 51 46.9454  1904.430
% 2022-Apr-25 06:00 *m  22 06 46.82 -18 09 58.4  176.403400  11.577533  21 51 56.8018  1904.570
% 2022-Apr-25 07:00 *m  22 08 28.78 -17 57 31.4  190.579306  11.343245  22 52 06.6581  1903.732
% 2022-Apr-25 08:00 *m  22 10 11.94 -17 44 26.4  204.574153   9.367784  23 52 16.5145  1901.931
% 2022-Apr-25 09:00 *m  22 11 58.18 -17 30 47.2  218.146051   5.815326  00 52 26.3709  1899.248
% 2022-Apr-25 10:00 *m  22 13 49.16 -17 16 40.0  231.203790   0.947414  01 52 36.2272  1895.821
% 2022-Apr-25 11:00 *   22 15 46.16 -17 02 11.9  243.820037  -4.926592  02 52 46.0836  1891.838
% 2022-Apr-25 12:00 *   22 17 50.05 -16 47 31.2  256.205351 -11.484051  03 52 55.9399  1887.521
% 2022-Apr-25 13:00 *   22 20 01.20 -16 32 46.2  268.677265 -18.399769  04 53 05.7963  1883.110
% 2022-Apr-25 14:00 *   22 22 19.50 -16 18 04.9  281.640341 -25.335226  05 53 15.6526  1878.847
% 2022-Apr-25 15:00 *   22 24 44.39 -16 03 34.5  295.567645 -31.912236  06 53 25.5089  1874.962
% 2022-Apr-25 16:00 *   22 27 14.84 -15 49 20.8  310.944315 -37.680690  07 53 35.3653  1871.658
% 2022-Apr-25 17:00 *   22 29 49.52 -15 35 28.5  328.101166 -42.104931  08 53 45.2216  1869.099
% 2022-Apr-25 18:00 *   22 32 26.80 -15 22 00.0  346.898394 -44.621808  09 53 55.0779  1867.403
% 2022-Apr-25 19:00 N   22 35 04.90 -15 08 56.4    6.470054 -44.817336  10 54 04.9342  1866.637
% 2022-Apr-25 20:00 N   22 37 41.97 -14 56 16.9   25.503011 -42.636849  11 54 14.7905  1866.812
% 2022-Apr-25 21:00 A   22 40 16.21 -14 43 58.9   42.990750 -38.413554  12 54 24.6468  1867.883
% 2022-Apr-25 22:00 A   22 42 45.96 -14 31 58.6   58.652771 -32.681218  13 54 34.5031  1869.750
% 2022-Apr-25 23:00 A   22 45 09.82 -14 20 10.8   72.754122 -25.976283  14 54 44.3594  1872.266
% 2022-Apr-26 00:00 A   22 47 26.70 -14 08 29.5   85.772823 -18.755387  15 54 54.2157  1875.241
AZ_H = [...
    98.911099; ...
    110.974777; ...
    123.132741; ...
    135.664824; ...
    148.735392; ...
    162.363134; ...
    176.403400; ...
    190.579306; ...
    204.574153; ...
    218.146051; ...
    231.203790; ...
    243.820037; ...
    256.205351; ...
    268.677265; ...
    281.640341; ...
    295.567645; ...
    310.944315; ...
    328.101166; ...
    346.898394; ...
    6.470054;   ...
    25.503011;  ...
    42.990750;  ...
    58.652771;  ...
    72.754122;  ...
    85.772823];

EL_H = [...
    -17.115599;  ...
    -10.035347;  ...
    -3.475416;  ...
    2.259312;  ...
    6.862202;  ...
    10.044539;  ...
    11.577533;  ...
    11.343245;  ...
    9.367784;  ...
    5.815326;  ...
    0.947414;  ...
    -4.926592;  ...
    -11.484051;  ...
    -18.399769;  ...
    -25.335226;  ...
    -31.912236;  ...
    -37.680690;  ...
    -42.104931;  ...
    -44.621808;  ...
    -44.817336;  ...
    -42.636849;  ...
    -38.413554;  ...
    -32.681218;  ...
    -25.976283;  ...
    -18.755387];

AD_H = [...
    1892.847; ...
    1896.009; ...
    1898.967; ...
    1901.488; ...
    1903.365; ...
    1904.430; ...
    1904.570; ...
    1903.732; ...
    1901.931; ...
    1899.248; ...
    1895.821; ...
    1891.838; ...
    1887.521; ...
    1883.110; ...
    1878.847; ...
    1874.962; ...
    1871.658; ...
    1869.099; ...
    1867.403; ...
    1866.637; ...
    1866.812; ...
    1867.883; ...
    1869.750; ...
    1872.266; ...
    1875.241];

lat = 60.205490;
lon = 24.0206;

lat = 60.198376;
lon = 24.7503;
alt = 51.788;

JTs = julian_time_ymdhms(2022, 4, 25, 0, 0, 0);
JTs = JTs:(1/24):(JTs + 1);

num_times = length(JTs);

AZ = [];
EL = [];
AD = [];

for ind_time = 1:num_times
    JT = JTs(ind_time);
    [RA, decl, dist] = position_moon(JT);
    N = matrix_mod_tod(JT);

    dist = dist * 1000;

    % Position of the Moon in J2000.
    r_tod = dist * [cosd(decl) * cosd(RA); ...
                    cosd(decl) * sind(RA); ...
                    sind(decl)]
    v_tod = 0 * r_tod;

    %[r_mod, v_mod] = coord_j2000_mod(JT, r_j2000, v_j2000);    
    %[r_tod, v_tod] = coord_mod_tod(JT, r_mod, v_mod, N);
    [r_pef, v_pef] = coord_tod_pef(JT, r_tod, v_tod, N);
    [r_efi, v_efi] = coord_pef_efi(r_pef, v_pef, 0.0, 0.0);
    [lat_moon, lon_moon, h] = coord_efi_wgs84(r_efi, 10, 1e-10, false)
    [r_enu, v_enu] = coord_efi_enu(r_efi, v_efi, lat, lon, 0);
    [az, el] = coord_enu_azel(r_enu, v_enu);

    r_obs = coord_wgs84_efi(lat, lon, alt);
    r_M = 1737400;
    dist_obs = norm(r_efi - r_obs);
    angular_diam = 2 * atand(r_M / dist_obs); 

    AZ = [AZ; az];
    EL = [EL; el];
    AD = [AD; angular_diam];
end

figure(1);
clf;
subplot(3, 1, 1);
plot(0:24, mod(AZ - AZ_H, 360), 'LineWidth', 2);
xlabel('Hour');
ylabel('Azimuth error (degrees)');
title('Error in the Position of the Moon w.r.t. JPL Horizons - 25.04.2022');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);

subplot(3, 1, 2);
plot(0:24, mod(abs(EL - EL_H), 360), 'LineWidth', 2);
xlabel('Hour');
ylabel('Elevation error (degrees)');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);

subplot(3, 1, 3);
plot(0:24, abs(AD * 3600 - AD_H), 'LineWidth', 2);
xlabel('Hour');
ylabel('Angular size error (arcseconds)');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);
