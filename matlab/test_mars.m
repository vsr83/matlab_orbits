% JPL Horizons
%

%****************************************************************************************************************************************
% Date__(UT)__HR:MN     Azimuth__(a-app)__Elevation  ObsSub-LON ObsSub-LAT    hEcl-Lon   hEcl-Lat  1-way_down_LT     ObsEcLon    ObsEcLat
%****************************************************************************************************************************************
% 2022-Apr-25 00:00 A    84.675303074 -14.728230924  174.166302 -24.440445  300.067757  -1.742835    13.83430436  337.4642705  -1.4747722
% 2022-Apr-25 01:00 N    97.684048004  -7.275539511  188.753021 -24.444226  300.093358  -1.743109    13.83225555  337.4957846  -1.4752239
% 2022-Apr-25 02:00 C   110.606377664  -0.046259179  203.339791 -24.448012  300.118960  -1.743383    13.83020751  337.5272521  -1.4756568
% 2022-Apr-25 03:00 *m  123.840611211   6.585726839  217.926608 -24.451805  300.144563  -1.743656    13.82816329  337.5586753  -1.4760692
% 2022-Apr-25 04:00 *m  137.687652204  12.238274857  232.513464 -24.455605  300.170168  -1.743930    13.82612569  337.5900596  -1.4764611
% 2022-Apr-25 05:00 *m  152.294554905  16.524568033  247.100350 -24.459412  300.195773  -1.744202    13.82409706  337.6214128  -1.4768337
% 2022-Apr-25 06:00 *m  167.586753993  19.092893673  261.687254 -24.463225  300.221380  -1.744475    13.82207917  337.6527452  -1.4771896
% 2022-Apr-25 07:00 *m  183.247526664  19.700108554  276.274161 -24.467040  300.246988  -1.744747    13.82007304  337.6840682  -1.4775325
% 2022-Apr-25 08:00 *m  198.811978424  18.284911490  290.861059 -24.470855  300.272597  -1.745019    13.81807891  337.7153939  -1.4778669
% 2022-Apr-25 09:00 *m  213.855847743  14.989389576  305.447933 -24.474667  300.298207  -1.745291    13.81609622  337.7467343  -1.4781980
% 2022-Apr-25 10:00 *m  228.156703006  10.111290646  320.034772 -24.478471  300.323818  -1.745562    13.81412361  337.7781003  -1.4785312
% 2022-Apr-25 11:00 *   241.736856948   4.024580137  334.621566 -24.482263  300.349431  -1.745833    13.81215908  337.8095010  -1.4788715
% 2022-Apr-25 12:00 *   254.814198291  -2.882403017  349.208308 -24.486040  300.375045  -1.746103    13.81020007  337.8409433  -1.4792239
% 2022-Apr-25 13:00 *   267.734383644 -10.231044653    3.794996 -24.489798  300.400659  -1.746374    13.80824364  337.8724311  -1.4795920
% 2022-Apr-25 14:00 *   280.924368644 -17.644432092   18.381629 -24.493535  300.426275  -1.746643    13.80628671  337.9039651  -1.4799788
% 2022-Apr-25 15:00 *   294.862216620 -24.719893160   32.968211 -24.497249  300.451893  -1.746913    13.80432622  337.9355431  -1.4803856
% 2022-Apr-25 16:00 *   310.025941904 -30.995603177   47.554749 -24.500939  300.477511  -1.747182    13.80235937  337.9671596  -1.4808126
% 2022-Apr-25 17:00 *   326.760009556 -35.934476039   62.141255 -24.504607  300.503131  -1.747451    13.80038383  337.9988067  -1.4812585
% 2022-Apr-25 18:00 *   345.021458515 -38.970858067   76.727739 -24.508254  300.528751  -1.747719    13.79839783  338.0304742  -1.4817207
% 2022-Apr-25 19:00 N     4.147571397 -39.663966964   91.314216 -24.511881  300.554373  -1.747988    13.79640035  338.0621507  -1.4821954
% 2022-Apr-25 20:00 N    23.015148758 -37.899869863  105.900699 -24.515492  300.579997  -1.748255    13.79439116  338.0938239  -1.4826781
% 2022-Apr-25 21:00 A    40.646472165 -33.955429980  120.487202 -24.519092  300.605621  -1.748523    13.79237084  338.1254819  -1.4831636
% 2022-Apr-25 22:00 A    56.663082937 -28.350697800  135.073736 -24.522683  300.631246  -1.748790    13.79034073  338.1571138  -1.4836465
% 2022-Apr-25 23:00 A    71.228694680 -21.650183974  149.660312 -24.526270  300.656873  -1.749057    13.78830286  338.1887105  -1.4841216
% 2022-Apr-26 00:00 A    84.770947799 -14.357967214  164.246936 -24.529856  300.682501  -1.749324    13.78625979  338.2202651  -1.4845843


AZ_H = [...
84.675303074; ...
97.684048004; ...
110.606377664; ...
123.840611211; ...
137.687652204; ...
152.294554905; ...
167.586753993; ...
183.247526664; ...
198.811978424; ...
213.855847743; ...
228.156703006; ...
241.736856948; ...
254.814198291; ...
267.734383644; ...
280.924368644; ...
294.862216620; ...
310.025941904; ...
326.760009556; ...
345.021458515; ...
4.147571397; ...
23.015148758; ...
40.646472165; ...
56.663082937; ...
71.228694680; ...
84.770947799];

EL_H = [...
-14.728230924; ...
-7.275539511; ...
-0.046259179; ...
6.585726839; ...
12.238274857; ...
16.524568033; ...
19.092893673; ...
19.700108554; ...
18.284911490; ...
14.989389576; ...
10.111290646; ...
4.024580137; ...
-2.882403017; ...
-10.231044653; ...
-17.644432092; ...
-24.719893160; ...
-30.995603177; ...
-35.934476039; ...
-38.970858067; ...
-39.663966964; ...
-37.899869863; ...
-33.955429980; ...
-28.350697800; ...
-21.650183974; ...
-14.357967214];

au_meters = 1.495978707e11;
mu = 1.32712440018e20;

lat = 60.205490;
lon = 24.0206;

lat = 60.1984210;
lon = 24.7503;
alt = 51.788;

JTs = julian_time_ymdhms(2022, 4, 25, 0, 0, 0);
JTs = JTs:(1/24):(JTs + 1);
JTs = JTs - 0.08994 / 86400;

num_times = length(JTs);

AZ = [];
EL = [];

for ind_time = 1:num_times
    JT = JTs(ind_time);

    N = matrix_mod_tod(JT);

    r_ec_earth = vsop87_earth(JT);
    r_ec_mars = vsop87_mars(JT-828/86400);
    [r_eq_earth, v_eq_earth] = coord_ecl_eq(JT, r_ec_earth, 0 * r_ec_earth);
    [r_eq_mars, v_eq_mars] = coord_ecl_eq(JT, r_ec_mars, 0 * r_ec_mars);

    r_j2000 = r_eq_mars - r_eq_earth;
    r_j2000 = aberration_stellar_cart(JT, r_j2000, 0 * r_j2000);

    [r_mod, v_mod] = coord_j2000_mod(JT, r_j2000, 0 * r_j2000);
    [r_tod, v_tod] = coord_mod_tod(JT, r_mod, v_mod, N);
    [r_pef, v_pef] = coord_tod_pef(JT, r_tod, v_tod, N);
    [r_efi, v_efi] = coord_pef_efi(r_pef, v_pef, 0.1362/3600, 0.4693/3600);
    [slat, slon, sh] = coord_efi_wgs84(r_efi);
    [r_enu, v_enu] = coord_efi_enu(r_efi, v_efi, lat, lon, 0);
    [az, el] = coord_enu_azel(r_enu, v_enu);

    AZ = [AZ; az];
    EL = [EL; el];
end

figure(1);
clf;
subplot(2, 1, 1);
plot(0:24, 3600*min(mod(AZ - AZ_H, 360), mod(AZ_H - AZ, 360)), 'LineWidth', 2);
xlabel('Hour');
ylabel('Azimuth error (arcseconds)');
title('Error in the Position of the Mars w.r.t. JPL Horizons - 25.04.2022');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);

subplot(2, 1, 2);
plot(0:24, 3600*mod(abs(EL - EL_H), 360), 'LineWidth', 2);
xlabel('Hour');
ylabel('Elevation error (arcseconds)');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);
