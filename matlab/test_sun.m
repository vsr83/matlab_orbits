% JPL Horizons
%
%**********************************************************************************************
% Date__(UT)__HR:MN     R.A.__(a-apparent)__DEC  Azi____(a-app)___Elev  L_Ap_Sid_Time  Ang-diam
%**********************************************************************************************
%$$SOE
% 2022-Apr-25 00:00 A   02 10 01.15 +13 06 40.6   25.330322 -13.945742  15 50 57.6634  1908.127
% 2022-Apr-25 01:00 N   02 10 10.64 +13 07 29.7   39.690781  -9.929833  16 51 07.5198  1908.111
% 2022-Apr-25 02:00 C   02 10 20.12 +13 08 18.9   53.371187  -4.514110  17 51 17.3762  1908.097
% 2022-Apr-25 03:00 *m  02 10 29.58 +13 09 08.1   66.485137   1.938770  18 51 27.2326  1908.085
% 2022-Apr-25 04:00 *m  02 10 39.03 +13 09 57.3   79.303555   9.062260  19 51 37.0890  1908.073
% 2022-Apr-25 05:00 *m  02 10 48.45 +13 10 46.5   92.207586  16.493507  20 51 46.9454  1908.062
% 2022-Apr-25 06:00 *m  02 10 57.86 +13 11 35.6  105.661679  23.855193  21 51 56.8018  1908.050
% 2022-Apr-25 07:00 *m  02 11 07.25 +13 12 24.7  120.187996  30.721553  22 52 06.6581  1908.037
% 2022-Apr-25 08:00 *m  02 11 16.62 +13 13 13.8  136.287997  36.582953  23 52 16.5145  1908.022
% 2022-Apr-25 09:00 *m  02 11 25.99 +13 14 02.7  154.228030  40.843803  00 52 26.3709  1908.005
% 2022-Apr-25 10:00 *m  02 11 35.34 +13 14 51.6  173.685649  42.919316  01 52 36.2272  1907.986
% 2022-Apr-25 11:00 *   02 11 44.70 +13 15 40.4  193.585478  42.459636  02 52 46.0836  1907.964
% 2022-Apr-25 12:00 *   02 11 54.06 +13 16 29.1  212.586864  39.548188  03 52 55.9399  1907.939
% 2022-Apr-25 13:00 *   02 12 03.42 +13 17 17.7  229.867642  34.650415  04 53 05.7963  1907.912
% 2022-Apr-25 14:00 *   02 12 12.80 +13 18 06.2  245.357737  28.376044  05 53 15.6526  1907.883
% 2022-Apr-25 15:00 *   02 12 22.20 +13 18 54.7  259.443795  21.294988  06 53 25.5089  1907.852
% 2022-Apr-25 16:00 *   02 12 31.62 +13 19 43.1  272.649997  13.884408  07 53 35.3653  1907.821
% 2022-Apr-25 17:00 *   02 12 41.06 +13 20 31.5  285.481424   6.548927  08 53 45.2216  1907.789
% 2022-Apr-25 18:00 *   02 12 50.52 +13 21 19.9  298.372999  -0.342111  09 53 55.0779  1907.758
% 2022-Apr-25 19:00 N   02 13 00.00 +13 22 08.3  311.667391  -6.425453  10 54 04.9342  1907.728
% 2022-Apr-25 20:00 N   02 13 09.49 +13 22 56.7  325.581351 -11.334373  11 54 14.7905  1907.699
% 2022-Apr-25 21:00 A   02 13 19.00 +13 23 45.1  340.154404 -14.718148  12 54 24.6468  1907.673
% 2022-Apr-25 22:00 A   02 13 28.52 +13 24 33.6  355.211254 -16.294155  13 54 34.5031  1907.649
% 2022-Apr-25 23:00 A   02 13 38.04 +13 25 22.1   10.395383 -15.916224  14 54 44.3594  1907.628
% 2022-Apr-26 00:00 A   02 13 47.56 +13 26 10.6   25.298565 -13.619600  15 54 54.2157  1907.610

AZ_H = [...
    25.330322; ...
    39.690781; ...
    53.371187; ...
    66.485137; ...
    79.303555; ...
    92.207586; ...
    105.661679; ...
    120.187996; ...
    136.287997; ...
    154.228030; ...
    173.685649; ...
    193.585478; ...
    212.586864; ...
    229.867642; ...
    245.357737; ...
    259.443795; ...
    272.649997; ...
    285.481424; ...
    298.372999; ...
    311.667391; ...
    325.581351; ...
    340.154404; ...
    355.211254; ...
    10.395383; ...
    25.298565];

EL_H = [...
    -13.945742; ...
    -9.929833; ...
    -4.514110; ...
     1.938770; ...
     9.062260; ...
    16.493507; ...
    23.855193; ...
    30.721553; ...
    36.582953; ...
    40.843803; ...
    42.919316; ...
    42.459636; ...
    39.548188; ...
    34.650415; ...
    28.376044; ...
    21.294988; ...
    13.884408; ...
     6.548927; ...
    -0.342111; ...
    -6.425453; ...
    -11.334373; ...
    -14.718148; ...
    -16.294155; ...
    -15.916224; ...
    -13.619600];

AD_H = [...
    1908.127; ...
    1908.111; ...
    1908.097; ...
    1908.085; ...
    1908.073; ...
    1908.062; ...
    1908.050; ...
    1908.037; ...
    1908.022; ...
    1908.005; ...
    1907.986; ...
    1907.964; ...
    1907.939; ...
    1907.912; ...
    1907.883; ...
    1907.852; ...
    1907.821; ...
    1907.789; ...
    1907.758; ...
    1907.728; ...
    1907.699; ...
    1907.673; ...
    1907.649; ...
    1907.628; ...
    1907.610];

au_meters = 1.495978707e11;
mu = 1.32712440018e20;

lat = 60.205490;
lon = 24.0206;

lat = 60.1984210;
lon = 24.7503;
alt = 51.788;

JTs = julian_time_ymdhms(2022, 4, 25, 0, 0, 0);
JTs = JTs:(1/24):(JTs + 1);
JTs = JTs - 0.08994 / 86400;

num_times = length(JTs);

AZ = [];
EL = [];
AD = [];
ELAT = [];
ELON = [];

for ind_time = 1:num_times
    JT = JTs(ind_time);

    N = matrix_mod_tod(JT);

    r_ec_earth = vsop87_earth(JT);
    r_ec_sun = [0;0;0];
    v_ec_sun = [0;0;0];

    % Compute speed in J2000 due to rotation of the Earth:
    r_obs_efi = coord_wgs84_efi(lat, lon, alt);
    [r_obs_pef, v_obs_pef] = coord_efi_pef(r_obs_efi, 0*r_obs_efi, 0, 0);
    [r_obs_tod, v_obs_tod] = coord_pef_tod(JT, r_obs_pef, v_obs_pef);
    [r_obs_mod, v_obs_mod] = coord_tod_mod(JT, r_obs_tod, v_obs_tod, N);
    [r_obs_j2000, v_obs_j2000] = coord_mod_j2000(JT, r_obs_mod, v_obs_mod);

    v_ec_earth = 0 * r_ec_earth;
    [r_eq_sun, v_eq_sun] = coord_ecl_eq(JT, -r_ec_earth, -v_ec_earth);

    r_eq_sun = aberration_stellar_cart(JT, r_eq_sun, v_obs_j2000);
    %[r_ecl_sun2, v_ecl_sun2] = coord_eq_ecl(JT, r_eq_sun, v_eq_sun);
    %ELON = [ELON; atan2d(r_ecl_sun2(2), r_ecl_sun2(1))];
    %ELAT = [ELAT; asind(r_ecl_sun2(3) / norm(r_ecl_sun2))];

    [r_mod, v_mod] = coord_j2000_mod(JT, r_eq_sun, v_eq_sun);
    [r_tod, v_tod] = coord_mod_tod(JT, r_mod, v_mod, N);
    [r_pef, v_pef] = coord_tod_pef(JT, r_tod, v_tod, N);
    [r_efi, v_efi] = coord_pef_efi(r_pef, v_pef, 0.1362/3600, 0.4693/3600);
    [slat, slon, sh] = coord_efi_wgs84(r_efi);
    [r_enu, v_enu] = coord_efi_enu(r_efi, v_efi, lat, lon, 0);
    [az, el] = coord_enu_azel(r_enu, v_enu);

    r_obs = coord_wgs84_efi(lat, lon, alt);
    r_S = 6.96340e8;
    dist_obs = norm(r_efi - r_obs);
    angular_diam = 2 * atand(r_S / dist_obs); 

    AZ = [AZ; az];
    EL = [EL; el];
    AD = [AD; angular_diam];
end

figure(1);
clf;
subplot(3, 1, 1);
plot(0:24, 3600*min(mod(AZ - AZ_H, 360), mod(AZ_H - AZ, 360)), 'LineWidth', 2);
xlabel('Hour');
ylabel('Azimuth error (arcseconds)');
title('Error in the Position of the Sun w.r.t. JPL Horizons - 25.04.2022');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);

subplot(3, 1, 2);
plot(0:24, 3600*mod(abs(EL - EL_H), 360), 'LineWidth', 2);
xlabel('Hour');
ylabel('Elevation error (arcseconds)');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);

subplot(3, 1, 3);
plot(0:24, abs(AD * 3600 - AD_H), 'LineWidth', 2);
xlabel('Hour');
ylabel('Angular size error (arcseconds)');
grid on;
set(gca, 'xtick', 0:24);
xlim([0 24]);
